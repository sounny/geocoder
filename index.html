<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sounny: AGOL Batch geocoding</title>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    .panel {
      display: grid;
      padding: 0px 10px 10px;
      width:  300px;
    }
    .results-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f2f2f2;
      padding: 10px;
    }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      padding: 5px;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.27/"></script>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/widgets/Expand",
    ], function(esriConfig, Map, MapView, Graphic, Expand) {

      esriConfig.apiKey = "AAPK5e9f3ac421344587846ccc6655bb15a5XbSd7hfogUjnRxVU0ztvl2YazFgwqjs0zsugjZwPUpfFhG5VSSLxC21yXKgjssqa";

      const map = new Map({
        basemap: "arcgis-navigation",
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-20, 30],
        zoom: 2,
        padding: {
          right: 300,
        },
        constraints: {
          snapToZoom: false
        }
      });

      const div = document.createElement("div");
      div.setAttribute("class", "esri-widget panel");

      const textarea = document.createElement("textarea");
      textarea.setAttribute("id", "userAddresses");
      textarea.setAttribute("rows", "4");
      textarea.setAttribute("cols", "30");
      textarea.placeholder = "Enter addresses here...";
      div.appendChild(textarea);

      const button = document.createElement("button");
      button.setAttribute("class", "esri-button");
      button.innerHTML = "Geocode addresses";
      div.appendChild(button);

      const buttonClear = document.createElement("button");
      buttonClear.setAttribute("class", "esri-button");
      buttonClear.innerHTML = "Clear";
      div.appendChild(buttonClear);

      view.ui.add(new Expand({
        view: view,
        content: div,
        expanded: true,
        mode: "floating"
      }), "top-right");

      const resultsPanel = document.createElement("div");
      resultsPanel.setAttribute("class", "results-panel");
      const resultsTable = document.createElement("table");
      const headerRow = resultsTable.insertRow(0);
      headerRow.insertCell(0).innerHTML = "<b>Address</b>";
      headerRow.insertCell(1).innerHTML = "<b>Longitude</b>";
      headerRow.insertCell(2).innerHTML = "<b>Latitude</b>";
      resultsPanel.appendChild(resultsTable);

      const copyButton = document.createElement("button");
      copyButton.innerHTML = "Copy to Clipboard";
      copyButton.addEventListener("click", () => {
        const tableText = Array.from(resultsTable.rows)
          .map(row => Array.from(row.cells).map(cell => cell.textContent).join("\t"))
          .join("\n");
        navigator.clipboard.writeText(tableText);
      });
      resultsPanel.appendChild(copyButton);

      document.body.appendChild(resultsPanel);

      button.addEventListener("click", async () => {
        const userAddresses = document.getElementById("userAddresses").value;
        const addressArray = userAddresses.split('\n');

        const params = {
          addresses: addressArray.map((address, index) => ({
            objectid: index + 1,
            address: address.trim(),
          })),
        };

        await geocodeAddresses(params);
      });

      buttonClear.addEventListener("click", () => {
        view.graphics.removeAll();
        view.closePopup();
      });

      async function geocodeAddresses(params) {
        while (resultsTable.rows.length > 1) {
          resultsTable.deleteRow(1);
        }

        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `addresses=${JSON.stringify(params)}&f=json&forStorage=false&token=Your-Token-Here`
        };

        try {
          const response = await fetch("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/geocodeAddresses", requestOptions);
          const data = await response.json();

          if (data.locations && data.locations.length > 0) {
            data.locations.forEach((location) => {
              addGraphic(location);
            });
          } else {
            console.log("No locations found.");
          }
        } catch (error) {
          console.error("There was an error with the geocoding request", error);
        }
      }

      function addGraphic(location) {
        const markerSymbol = {
          type: "simple-marker",
          outline: {
            color: "white",
            width: 1.5,
          },
          color: "black",
          size: "10px",
        };

        const graphic = new Graphic({
          geometry: location.location,
          symbol: markerSymbol,
          attributes: location.attributes,
        });

        view.graphics.add(graphic);

        const row = resultsTable.insertRow(-1);
        row.insertCell(0).innerHTML = location.attributes.User_fld;
        row.insertCell(1).innerHTML = location.location.x.toFixed(5);
        row.insertCell(2).innerHTML = location.location.y.toFixed(5);
      }
    });

    async function testGeocoding() {
  const singleAddress = {
    addresses: [{
      objectid: 1,
      address: "1600 Amphitheatre Parkway, Mountain View, CA",
    }],
  };

  const requestOptions = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `addresses=${JSON.stringify(singleAddress)}&f=json&forStorage=false&token=Your-Token-Here`
  };

  try {
    const response = await fetch("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/geocodeAddresses", requestOptions);
    const data = await response.json();
    console.log("Test Geocoding Data:", data);
  } catch (error) {
    console.error("There was an error with the test geocoding request", error);
  }
}

// Call the test function
testGeocoding();

  </script>
</head>
<body>
  <div id="viewDiv"></div>
</body>
</html>
