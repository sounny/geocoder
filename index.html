<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sounny: AGOL Batch geocoding</title>
  <style>
    :root {
      --arcgis-blue: #0079c1;
      --border-color: #dcdcdc;
      --text-muted: #4b4b4b;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Avenir Next", "Helvetica Neue", Arial, sans-serif;
      background: #f7f9fb;
      color: #2d2d2d;
      line-height: 1.5;
    }

    #viewDiv {
      height: 70vh;
      width: 100%;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    .app-header {
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--border-color);
      background: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .app-header h1 {
      margin: 0 0 4px;
      font-size: 22px;
      font-weight: 700;
    }

    .app-header p {
      margin: 0;
      color: var(--text-muted);
    }

    .panel {
      display: grid;
      gap: 6px;
      padding: 10px 12px 12px;
      width: 320px;
    }

    .panel h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .panel p {
      margin: 0 0 6px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .panel label {
      font-weight: 600;
      font-size: 14px;
    }

    .panel textarea {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
    }

    .panel .button-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .panel .helper-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .results-section {
      padding: 16px 12px 32px;
      background: white;
      box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.04);
    }

    .status-bar {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #f2f6fb;
      margin: 0 0 12px;
      color: #184f77;
    }

    .status-success {
      background: #f1f9f3;
      color: #1e5c37;
      border-color: #c8e6cf;
    }

    .status-error {
      background: #fdf2f2;
      color: #7f1d1d;
      border-color: #f5c2c7;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 14px;
    }

    th,
    td {
      border: 1px solid var(--border-color);
      padding: 10px 8px;
      text-align: left;
    }

    th {
      background: #f3f5f8;
      font-weight: 700;
    }

    .results-table .clickable-row {
      cursor: pointer;
    }

    .results-table .selected-row {
      background-color: #d2e9f9;
    }

    .results-table .empty-row td {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
    }

    .api-key-banner {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fdf8e3;
      border: 1px solid #f4d58d;
      border-radius: 4px;
      padding: 8px 10px;
      margin-top: 8px;
      color: #8a6308;
      font-size: 14px;
    }

    .api-key-banner strong {
      font-weight: 700;
    }

    .api-key-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .api-key-modal__card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      max-width: 420px;
      width: calc(100% - 32px);
      display: grid;
      gap: 10px;
    }

    .api-key-modal__card h3 {
      margin: 0;
    }

    .api-key-modal__card label {
      font-weight: 600;
    }

    .api-key-modal__card input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: inherit;
    }

    .api-key-modal__actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }
  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
</head>
<body>
  <header class="app-header">
    <h1>Interactive Batch Geocoder</h1>
    <p>Geocode many addresses at once, export results, and explore them on the map.</p>
    <div id="apiKeyBanner" class="api-key-banner" role="status" aria-live="polite"></div>
  </header>
  <div id="viewDiv"></div>
  <section class="results-section">
    <div id="statusMessage" class="status-bar" role="status" aria-live="polite">Enter addresses and click "Geocode addresses" to get started.</div>
    <table class="results-table">
      <thead>
          <tr>
            <th>User Input</th>
            <th>Address</th>
            <th>Longitude</th>
            <th>Latitude</th>
          </tr>
      </thead>
      <tbody id="resultsBody">
        <tr class="empty-row">
          <td colspan="4">Results will appear here after geocoding.</td>
        </tr>
      </tbody>
    </table>
  </section>

  <script src="https://js.arcgis.com/4.27/"></script>
  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/rest/locator",
      "esri/Graphic",
      "esri/widgets/Expand",
    ], (esriConfig, Map, MapView, locator, Graphic, Expand) => {
      const API_KEY_STORAGE = "geocoder.agolApiKey";
      const storedApiKey = localStorage.getItem(API_KEY_STORAGE) || "";
      let currentApiKey = storedApiKey;
      esriConfig.apiKey = currentApiKey;

      const map = new Map({
        basemap: "osm",
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-20, 30],
        zoom: 2,
      });

      const statusElement = document.getElementById("statusMessage");

      const div = document.createElement("div");
      div.setAttribute("class", "esri-widget panel");

      const panelTitle = document.createElement("h2");
      panelTitle.textContent = "Batch geocoder";
      div.appendChild(panelTitle);

      const panelDescription = document.createElement("p");
      panelDescription.textContent = "Paste addresses (one per line) and geocode them in one click.";
      div.appendChild(panelDescription);

      const label = document.createElement("label");
      label.setAttribute("for", "userAddresses");
      label.textContent = "Addresses";
      div.appendChild(label);

      const textarea = document.createElement("textarea");
      textarea.setAttribute("id", "userAddresses");
      textarea.setAttribute("rows", "5");
      textarea.setAttribute("cols", "30");
      textarea.placeholder = "123 Main St, Austin, TX\nMarrakech, Morocco\nParis, France";
      textarea.value = "Austin, Texas\nMarrakech, Morocco\nParis, France";
      div.appendChild(textarea);

      const helperText = document.createElement("div");
      helperText.classList.add("helper-text");
      helperText.textContent = "Supports multi-line input; blank lines are ignored.";
      div.appendChild(helperText);

      const buttonRow = document.createElement("div");
      buttonRow.classList.add("button-row");
      div.appendChild(buttonRow);

      const geocodeButton = document.createElement("button");
      geocodeButton.setAttribute("class", "esri-button");
      geocodeButton.innerHTML = "Geocode addresses";
      buttonRow.appendChild(geocodeButton);

      const buttonClear = document.createElement("button");
      buttonClear.setAttribute("class", "esri-button esri-button--secondary");
      buttonClear.innerHTML = "Clear results";
      buttonRow.appendChild(buttonClear);

      const exportCsvBtn = document.createElement("button");
      exportCsvBtn.setAttribute("class", "esri-button esri-button--secondary");
      exportCsvBtn.innerHTML = "Export CSV";
      buttonRow.appendChild(exportCsvBtn);

      const exportGeoBtn = document.createElement("button");
      exportGeoBtn.setAttribute("class", "esri-button esri-button--secondary");
      exportGeoBtn.innerHTML = "Export GeoJSON";
      buttonRow.appendChild(exportGeoBtn);

      const apiKeyBanner = document.getElementById("apiKeyBanner");

      const apiKeyForm = document.createElement("form");
      apiKeyForm.classList.add("esri-widget", "panel");
      apiKeyForm.style.width = "280px";

      const apiKeyTitle = document.createElement("h2");
      apiKeyTitle.textContent = "API key settings";
      apiKeyForm.appendChild(apiKeyTitle);

      const apiKeySummary = document.createElement("p");
      apiKeySummary.textContent = "Enter your ArcGIS Online API key. It is stored locally and used for all map requests.";
      apiKeyForm.appendChild(apiKeySummary);

      const apiKeyLabel = document.createElement("label");
      apiKeyLabel.setAttribute("for", "apiKeyInput");
      apiKeyLabel.textContent = "AGOL API key";
      apiKeyForm.appendChild(apiKeyLabel);

      const apiKeyInput = document.createElement("input");
      apiKeyInput.type = "text";
      apiKeyInput.id = "apiKeyInput";
      apiKeyInput.placeholder = "Enter your ArcGIS Online API key";
      apiKeyInput.value = currentApiKey;
      apiKeyForm.appendChild(apiKeyInput);

      const apiKeyActions = document.createElement("div");
      apiKeyActions.classList.add("button-row");
      apiKeyForm.appendChild(apiKeyActions);

      const saveApiKeyBtn = document.createElement("button");
      saveApiKeyBtn.type = "submit";
      saveApiKeyBtn.classList.add("esri-button");
      saveApiKeyBtn.textContent = "Save API key";
      apiKeyActions.appendChild(saveApiKeyBtn);

      const clearApiKeyBtn = document.createElement("button");
      clearApiKeyBtn.type = "button";
      clearApiKeyBtn.classList.add("esri-button", "esri-button--secondary");
      clearApiKeyBtn.textContent = "Clear key";
      apiKeyActions.appendChild(clearApiKeyBtn);

      apiKeyForm.addEventListener("submit", (event) => {
        event.preventDefault();
        applyApiKey(apiKeyInput.value.trim());
        settingsExpand.expanded = false;
      });

      clearApiKeyBtn.addEventListener("click", () => {
        applyApiKey("");
        settingsExpand.expanded = false;
      });

      const settingsExpand = new Expand({
        view: view,
        content: apiKeyForm,
        expanded: false,
        mode: "floating",
        expandIconClass: "esri-icon-gear",
        expandTooltip: "API key settings",
      });
      view.ui.add(settingsExpand, "top-left");

      view.ui.add(new Expand({
        view: view,
        content: div,
        expanded: true,
        mode: "floating"
      }), "top-right");

      const featureLookup = new Map();
      let activeResultId = null;

      const defaultMarkerSymbol = {
        type: "simple-marker",
        outline: {
          color: "white",
          width: 2,
        },
        color: "black",
        size: "15px",
      };

      const highlightedMarkerSymbol = {
        ...defaultMarkerSymbol,
        outline: { ...defaultMarkerSymbol.outline },
        color: "#0079c1",
      };

      function cloneSymbol(symbol) {
        return { ...symbol, outline: { ...symbol.outline } };
      }

      function setStatus(message, status = "info") {
        const classNames = ["status-bar"];
        if (status === "success") {
          classNames.push("status-success");
        }
        if (status === "error") {
          classNames.push("status-error");
        }
        statusElement.className = classNames.join(" ");
        statusElement.textContent = message;
      }

      function updateApiKeyBanner() {
        const ending = currentApiKey ? currentApiKey.slice(-4) : "";
        apiKeyInput.value = currentApiKey;
        apiKeyBanner.innerHTML = currentApiKey
          ? `<strong>API key:</strong> Stored (ending in ${ending}).`
          : `<strong>API key required:</strong> Add your ArcGIS Online key to geocode.`;
      }

      function applyApiKey(nextKey) {
        currentApiKey = nextKey;
        esriConfig.apiKey = nextKey;
        localStorage.setItem(API_KEY_STORAGE, nextKey);
        updateApiKeyBanner();
        geocodeButton.disabled = !Boolean(nextKey);
        const message = nextKey
          ? "API key saved. You can now geocode addresses."
          : "API key removed. Please add one to continue.";
        setStatus(message, nextKey ? "success" : "error");
      }

      function showApiKeyModal() {
        const modal = document.createElement("div");
        modal.className = "api-key-modal";
        const card = document.createElement("div");
        card.className = "api-key-modal__card esri-widget";

        const heading = document.createElement("h3");
        heading.textContent = "Enter your ArcGIS Online API key";
        card.appendChild(heading);

        const description = document.createElement("p");
        description.textContent = "The key is stored in this browser so you only need to enter it once.";
        card.appendChild(description);

        const form = document.createElement("form");
        form.autocomplete = "off";

        const label = document.createElement("label");
        label.setAttribute("for", "modalApiKeyInput");
        label.textContent = "AGOL API key";
        form.appendChild(label);

        const modalInput = document.createElement("input");
        modalInput.type = "text";
        modalInput.id = "modalApiKeyInput";
        modalInput.placeholder = "Enter your ArcGIS Online API key";
        modalInput.value = currentApiKey;
        form.appendChild(modalInput);

        const actions = document.createElement("div");
        actions.className = "api-key-modal__actions";

        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.classList.add("esri-button", "esri-button--secondary");
        cancelBtn.textContent = "Cancel";
        actions.appendChild(cancelBtn);

        const saveBtn = document.createElement("button");
        saveBtn.type = "submit";
        saveBtn.classList.add("esri-button");
        saveBtn.textContent = "Save key";
        actions.appendChild(saveBtn);

        form.appendChild(actions);
        card.appendChild(form);
        modal.appendChild(card);

        form.addEventListener("submit", (event) => {
          event.preventDefault();
          applyApiKey(modalInput.value.trim());
          modal.remove();
        });

        cancelBtn.addEventListener("click", () => {
          modal.remove();
        });

        document.body.appendChild(modal);
        modalInput.focus();
      }

      function initializeApiKeyState() {
        updateApiKeyBanner();
        geocodeButton.disabled = !Boolean(currentApiKey);
        if (!currentApiKey) {
          setStatus("Enter your ArcGIS Online API key to start geocoding.", "error");
          showApiKeyModal();
        }
      }

      function updateExportButtons() {
        const hasResults = document.querySelectorAll("#resultsBody tr").length > 0 && !document.querySelector(".empty-row");
        exportCsvBtn.disabled = !hasResults;
        exportGeoBtn.disabled = !hasResults;
      }

      function clearTablePlaceholder() {
        const placeholder = document.querySelector(".empty-row");
        if (placeholder) {
          placeholder.remove();
        }
      }

      function resetTable() {
        const tableBody = document.getElementById("resultsBody");
        tableBody.innerHTML = "";
        const placeholderRow = document.createElement("tr");
        placeholderRow.classList.add("empty-row");
        placeholderRow.innerHTML = '<td colspan="4">Results will appear here after geocoding.</td>';
        tableBody.appendChild(placeholderRow);
      }

      function getUserAddresses() {
        return document
          .getElementById("userAddresses")
          .value.split("\n")
          .map((address) => address.trim())
          .filter(Boolean);
      }

      geocodeButton.addEventListener("click", () => {
        if (!currentApiKey) {
          setStatus("Please add your ArcGIS Online API key before geocoding.", "error");
          showApiKeyModal();
          return;
        }

        const addressArray = getUserAddresses();

        if (addressArray.length === 0) {
          setStatus("Please add at least one address before geocoding.", "error");
          return;
        }

        const params = {
          addresses: addressArray.map((address, index) => ({
            OBJECTID: index + 1,
            SingleLine: address,
          })),
        };

        resetTable();
        updateExportButtons();
        setStatus(`Geocoding ${addressArray.length} address${addressArray.length > 1 ? "es" : ""}...`, "info");
        geocodeAddresses(params, addressArray);
      });

      exportCsvBtn.addEventListener("click", exportCSV);
      exportGeoBtn.addEventListener("click", exportGeoJSON);

      buttonClear.addEventListener("click", () => {
        view.graphics.removeAll();
        resetTable();
        clearSelection();
        featureLookup.clear();
        updateExportButtons();
        setStatus("Cleared map and table results.", "info");
      });

      function clearSelection() {
        if (activeResultId === null) {
          return;
        }

        const selected = featureLookup.get(activeResultId);
        if (selected) {
          selected.row.classList.remove("selected-row");
          selected.graphic.symbol = cloneSymbol(defaultMarkerSymbol);
        }
        activeResultId = null;
      }

      function selectFeature(resultId, { openPopup = false } = {}) {
        if (!featureLookup.has(resultId)) {
          return;
        }

        if (activeResultId !== resultId) {
          clearSelection();
          const nextSelection = featureLookup.get(resultId);
          nextSelection.row.classList.add("selected-row");
          nextSelection.graphic.symbol = cloneSymbol(highlightedMarkerSymbol);
          activeResultId = resultId;
        }

        if (openPopup) {
          const selected = featureLookup.get(resultId);
          view.popup.open({
            features: [selected.graphic],
            location: selected.graphic.geometry,
          });
        }
      }

      view.popup.watch("selectedFeature", (feature) => {
        if (!feature) {
          clearSelection();
          return;
        }

        const resultId = feature.attributes?.ResultID;
        if (resultId !== undefined) {
          selectFeature(resultId);
        }
      });

      view.popup.watch("visible", (visible) => {
        if (!visible) {
          clearSelection();
        }
      });

      function geocodeAddresses(params, inputs) {
        view.graphics.removeAll();
        clearSelection();
        featureLookup.clear();
        const geocodingServiceUrl = "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";
        locator.addressesToLocations(geocodingServiceUrl, params).then(
          (result) => {
            if (!result.length) {
              setStatus("No results returned. Please adjust the addresses and try again.", "error");
            }
            const foundIds = new Set();
            result.forEach((g) => {
              const id = g.attributes.ResultID;
              g.userInput = inputs[id - 1];
              addGraphic(g);
              foundIds.add(id);
            });
            const missing = [];
            params.addresses.forEach((addr) => {
              if (!foundIds.has(addr.OBJECTID)) {
                missing.push(addr.SingleLine);
                const tableBody = document.getElementById("resultsBody");
                clearTablePlaceholder();
                const row = tableBody.insertRow();
                row.style.backgroundColor = "#fdd";
                row.insertCell(0).innerHTML = addr.SingleLine;
                row.insertCell(1).innerHTML = "No result";
                row.insertCell(2).innerHTML = "-";
                row.insertCell(3).innerHTML = "-";
              }
            });
            if (missing.length > 0) {
              alert("Warning: could not geocode:\n" + missing.join("\n"));
              setStatus(`Located ${result.length} of ${params.addresses.length} addresses.`, "error");
            } else {
              setStatus(`Located ${result.length} address${result.length !== 1 ? "es" : ""}.`, "success");
            }
            if (!missing.length && result.length === 0) {
              setStatus("No results returned. Please adjust the addresses and try again.", "error");
            }
            updateExportButtons();
          },
          function (error) {
            console.log(error);
            setStatus("Geocoding failed. Please try again in a moment.", "error");
          }
        );
      }

      function addGraphic(result) {
        const graphic = new Graphic({
          geometry: result.location,
          symbol: cloneSymbol(defaultMarkerSymbol),
          attributes: { ...result.attributes, userInput: result.userInput },
          popupTemplate: {
            title: "{userInput}",
            content: "{LongLabel}"
          }
        });

        view.graphics.add(graphic);

        const tableBody = document.getElementById("resultsBody");
        clearTablePlaceholder();
        const row = tableBody.insertRow();
        row.classList.add("clickable-row");
        row.dataset.resultId = result.attributes.ResultID;
        const cell1 = row.insertCell(0);
        const cell2 = row.insertCell(1);
        const cell3 = row.insertCell(2);
        const cell4 = row.insertCell(3);
        cell1.innerHTML = result.userInput;
        cell2.innerHTML = result.attributes.LongLabel;
        cell3.innerHTML = result.location.x.toFixed(5);
        cell4.innerHTML = result.location.y.toFixed(5);

        row.addEventListener("click", () => {
          selectFeature(result.attributes.ResultID, { openPopup: true });
        });

        featureLookup.set(result.attributes.ResultID, { graphic, row });
        updateExportButtons();
      }

      function exportCSV() {
        const rows = Array.from(document.querySelectorAll("#resultsBody tr"));
        let csv = "User Input,Address,Longitude,Latitude\n";
        rows.forEach((row) => {
          if (row.classList.contains("empty-row")) {
            return;
          }
          const cells = Array.from(row.cells).map((c) => c.textContent);
          csv += cells.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "results.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      }

      function exportGeoJSON() {
        const features = view.graphics.items.map((g) => {
          const lon = g.geometry.longitude ?? g.geometry.x;
          const lat = g.geometry.latitude ?? g.geometry.y;
          return {
            type: "Feature",
            properties: {
              userInput: g.attributes.userInput,
              address: g.attributes.LongLabel,
            },
            geometry: {
              type: "Point",
              coordinates: [lon, lat],
            },
          };
        });
        const geojson = { type: "FeatureCollection", features };
        const blob = new Blob([JSON.stringify(geojson, null, 2)], {
          type: "application/json",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "results.geojson";
        link.click();
        URL.revokeObjectURL(link.href);
      }

      initializeApiKeyState();
      updateExportButtons();
    });
  </script>
</body>
</html>
