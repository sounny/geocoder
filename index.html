<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sounny: AGOL Batch geocoding</title>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    .panel {
      display: grid;
      padding: 0px 10px 10px;
      width:  300px;
    }
    .addresses {
      overflow:hidden;
    }
    .esri-view .esri-ui {
      inset: 0 !important;
    }
    .esri-button {
      margin-bottom: 5px;
    }
    .esri-view .esri-component.esri-attribution {
      position: fixed;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.27/"></script>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/rest/locator",
      "esri/Graphic",
      "esri/widgets/Expand",
    ], (esriConfig, Map, MapView, locator, Graphic, Expand) => {

      esriConfig.apiKey = "AAPK5e9f3ac421344587846ccc6655bb15a5XbSd7hfogUjnRxVU0ztvl2YazFgwqjs0zsugjZwPUpfFhG5VSSLxC21yXKgjssqa";

      const map = new Map({
        basemap: "arcgis-navigation",
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-20, 30],
        zoom: 2,
        padding: {
          right: 300,
        },
        constraints: {
          snapToZoom: false
        }
      });

      view.popup.actions = [];
      view.popup.dockOptions = {
        breakpoint: false,
        buttonEnabled: false
      }

      const div = document.createElement("div");
      div.setAttribute("class", "esri-widget panel");

      const textarea = document.createElement("textarea");
      textarea.setAttribute("id", "userAddresses");
      textarea.setAttribute("rows", "4");
      textarea.setAttribute("cols", "30");
      textarea.placeholder = "Enter addresses here...";
      div.appendChild(textarea);

      const button = document.createElement("button");
      button.setAttribute("class", "esri-button");
      button.innerHTML = "Geocode addresses";
      div.appendChild(button);

      const buttonClear = document.createElement("button");
      buttonClear.setAttribute("class", "esri-button");
      buttonClear.innerHTML = "Clear";
      div.appendChild(buttonClear);

      view.ui.add(new Expand({
        view: view,
        content: div,
        expanded: true,
        mode: "floating"
      }), "top-right");

      button.addEventListener("click", () => {
        const userAddresses = document.getElementById("userAddresses").value;
        const addressArray = userAddresses.split('\n');

        const params = {
          addresses: addressArray.map((address, index) => ({
            objectid: index + 1,
            address: address.trim(),
          })),
        };

        geocodeAddresses(params);
      });

      buttonClear.addEventListener("click", clearGraphics);

      const geocodingServiceUrl = "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";

      function geocodeAddresses(params) {
        view.graphics.removeAll();
        locator.addressesToLocations(geocodingServiceUrl, params).then(
          (result) => {
            if (result.length === 0) {
              return;
            }
            result.forEach((g) => {
              addGraphic(g);
            });
            const graphics = view.graphics.sort((a, b) => {
              return a.attributes.ResultID - b.attributes.ResultID;
            });
            view
              .goTo({
                target: graphics,
                zoom: 11,
              })
              .then(() => {
                view.openPopup({
                  features: graphics.toArray(),
                  updateLocationEnabled: true,
                });
              });
          },
          function (error) {
            console.log(error);
          }
        );
      }

      function clearGraphics() {
        view.graphics.removeAll();
        view.closePopup();  // Use the updated method
      }

      function addGraphic(result) {
        const markerSymbol = {
          type: "simple-marker",
          outline: {
            color: "white",
            width: 1.5,
          },
          color: "black",
          size: "10px",
        };

        const graphic = new Graphic({
          geometry: result.location,
          symbol: markerSymbol,
          attributes: result.attributes,
          popupTemplate: {
            title: "Address #" + result.attributes.ResultID,
            content:
              result.attributes.LongLabel +
              "<br>" +
              result.attributes.Type +
              "<br><br>" +
              result.location.x.toFixed(5) +
              ", " +
              result.location.y.toFixed(5),
          },
        });

        view.graphics.add(graphic);
      }
    });
  </script>
</head>
<body>
  <div id="viewDiv"></div>
</body>
</html>
